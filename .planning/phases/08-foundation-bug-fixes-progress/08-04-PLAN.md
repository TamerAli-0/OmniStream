---
phase: 08-foundation-bug-fixes-progress
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - app/src/main/java/com/omnistream/ui/home/HomeViewModel.kt
  - app/src/main/java/com/omnistream/ui/home/HomeScreen.kt
autonomous: true

must_haves:
  truths:
    - "User sees a Continue Watching row on Home screen showing most recent video content with progress bars"
    - "User sees a Continue Reading row on Home screen showing most recent manga content with percentage overlays"
    - "Continue rows appear at the top of Home screen, above all other content"
    - "Completed content (>90% watched, fully read) does not appear in Continue rows"
    - "Rows are hidden entirely when no history exists"
    - "Tapping an item navigates to the content"
    - "Long pressing shows a dropdown with Delete option"
    - "Maximum 10 items per row, ordered by most recently watched/read"
  artifacts:
    - path: "app/src/main/java/com/omnistream/ui/home/HomeViewModel.kt"
      provides: "Continue Watching/Reading state from WatchHistoryRepository"
      contains: "watchHistoryRepository"
    - path: "app/src/main/java/com/omnistream/ui/home/HomeScreen.kt"
      provides: "Continue Watching and Continue Reading row composables"
      contains: "ContinueWatchingCard"
  key_links:
    - from: "HomeViewModel.kt"
      to: "WatchHistoryRepository"
      via: "Hilt injection + Flow collection"
      pattern: "watchHistoryRepository\\.getContinueWatching"
    - from: "HomeScreen.kt"
      to: "HomeViewModel continueWatching/continueReading state"
      via: "uiState collection and rendering"
      pattern: "continueWatching|continueReading"
    - from: "HomeScreen.kt ContinueWatchingCard"
      to: "NavController"
      via: "onClick navigation to video/manga detail"
      pattern: "navController\\.navigate"
---

<objective>
Add Continue Watching and Continue Reading rows to the Home screen (PLAYER-01).

Purpose: Users see their most recent in-progress content at the top of the Home screen, Netflix-style. Video items show a thin progress bar at the bottom of the thumbnail. Manga items show a percentage text overlay. This completes the user-facing progress tracking feature.

Output: Updated HomeViewModel.kt with continue row state, updated HomeScreen.kt with two new row composables and long-press dropdown menu.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-foundation-bug-fixes-progress/08-CONTEXT.md
@.planning/phases/08-foundation-bug-fixes-progress/08-RESEARCH.md

Key source files:
@app/src/main/java/com/omnistream/ui/home/HomeViewModel.kt
@app/src/main/java/com/omnistream/ui/home/HomeScreen.kt
@app/src/main/java/com/omnistream/data/local/WatchHistoryEntity.kt (from Plan 01)
@app/src/main/java/com/omnistream/data/repository/WatchHistoryRepository.kt (from Plan 01)

Plan 01 SUMMARY (if available):
@.planning/phases/08-foundation-bug-fixes-progress/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Continue Watching/Reading state to HomeViewModel</name>
  <files>
    app/src/main/java/com/omnistream/ui/home/HomeViewModel.kt
  </files>
  <action>
    **HomeViewModel.kt -- inject WatchHistoryRepository, add continue row state:**

    1. Add `WatchHistoryRepository` to constructor:
       ```kotlin
       @HiltViewModel
       class HomeViewModel @Inject constructor(
           private val sourceManager: SourceManager,
           private val watchHistoryRepository: WatchHistoryRepository
       ) : ViewModel()
       ```

    2. Add to `HomeUiState`:
       ```kotlin
       data class HomeUiState(
           val isLoading: Boolean = true,
           val error: String? = null,
           val mangaSections: List<MangaSection> = emptyList(),
           val videoSections: List<VideoSection> = emptyList(),
           val continueWatching: List<WatchHistoryEntity> = emptyList(),
           val continueReading: List<WatchHistoryEntity> = emptyList()
       )
       ```

    3. In `init {}`, add two Flow collectors BEFORE `loadHomeContent()`:
       ```kotlin
       init {
           // Observe continue rows (reactive, auto-updates when progress changes)
           viewModelScope.launch {
               watchHistoryRepository.getContinueWatching().collect { items ->
                   _uiState.value = _uiState.value.copy(continueWatching = items)
               }
           }
           viewModelScope.launch {
               watchHistoryRepository.getContinueReading().collect { items ->
                   _uiState.value = _uiState.value.copy(continueReading = items)
               }
           }
           loadHomeContent()
       }
       ```

    4. Add a `deleteFromHistory(id: String)` method:
       ```kotlin
       fun deleteFromHistory(id: String) {
           viewModelScope.launch {
               watchHistoryRepository.delete(id)
           }
       }
       ```
       This is called when user long-presses and selects "Delete" from the dropdown.

    5. Add imports: `com.omnistream.data.local.WatchHistoryEntity`, `com.omnistream.data.repository.WatchHistoryRepository`.

    6. In the `refresh()` method, do NOT clear continue rows (they come from Room, not network). Keep `sourceHealth.clear()` and `loadHomeContent()` as-is. The continue rows auto-refresh via Flow.
  </action>
  <verify>Run `cd C:/Users/black/AndroidStudioProjects/omnistream && ./gradlew compileDebugKotlin 2>&1 | grep -i "home"`. No compilation errors in HomeViewModel. Verify `watchHistoryRepository` is in the constructor.</verify>
  <done>HomeViewModel injects WatchHistoryRepository, collects continueWatching and continueReading as Flows, and exposes them in HomeUiState. Delete function exists for removing items from history.</done>
</task>

<task type="auto">
  <name>Task 2: Add Continue Watching/Reading rows to HomeScreen with progress indicators and long-press menu</name>
  <files>
    app/src/main/java/com/omnistream/ui/home/HomeScreen.kt
  </files>
  <action>
    **HomeScreen.kt -- add Continue rows at top of LazyColumn with Netflix-style cards:**

    1. Add imports at the top:
       - `androidx.compose.foundation.ExperimentalFoundationApi`
       - `androidx.compose.foundation.combinedClickable`
       - `androidx.compose.material3.DropdownMenu`
       - `androidx.compose.material3.DropdownMenuItem`
       - `androidx.compose.material3.LinearProgressIndicator`
       - `com.omnistream.data.local.WatchHistoryEntity`

    2. In the `else` branch of the `when` block (the LazyColumn), add Continue rows at the TOP, BEFORE the video sections. Inside the `LazyColumn`:
       ```kotlin
       LazyColumn(...) {
           // Continue Watching row (only if items exist)
           if (uiState.continueWatching.isNotEmpty()) {
               item {
                   ContinueWatchingRow(
                       items = uiState.continueWatching,
                       onItemClick = { item ->
                           val encodedId = URLEncoder.encode(item.contentId, "UTF-8")
                           navController.navigate("video/${item.sourceId}/$encodedId")
                       },
                       onDeleteItem = { item ->
                           viewModel.deleteFromHistory(item.id)
                       }
                   )
               }
           }

           // Continue Reading row (only if items exist)
           if (uiState.continueReading.isNotEmpty()) {
               item {
                   ContinueReadingRow(
                       items = uiState.continueReading,
                       onItemClick = { item ->
                           val encodedId = URLEncoder.encode(item.contentId, "UTF-8")
                           navController.navigate("manga/${item.sourceId}/$encodedId")
                       },
                       onDeleteItem = { item ->
                           viewModel.deleteFromHistory(item.id)
                       }
                   )
               }
           }

           // Existing video sections
           items(uiState.videoSections) { ... }
           // Existing manga sections
           items(uiState.mangaSections) { ... }
           // Existing empty state
           ...
       }
       ```

    3. Create `ContinueWatchingRow` composable:
       ```kotlin
       @Composable
       private fun ContinueWatchingRow(
           items: List<WatchHistoryEntity>,
           onItemClick: (WatchHistoryEntity) -> Unit,
           onDeleteItem: (WatchHistoryEntity) -> Unit
       ) {
           Column {
               Text(
                   text = "Continue Watching",
                   style = MaterialTheme.typography.titleLarge,
                   fontWeight = FontWeight.Bold,
                   color = MaterialTheme.colorScheme.onBackground,
                   modifier = Modifier.padding(horizontal = 16.dp)
               )
               Spacer(modifier = Modifier.height(12.dp))
               LazyRow(
                   contentPadding = PaddingValues(horizontal = 16.dp),
                   horizontalArrangement = Arrangement.spacedBy(12.dp)
               ) {
                   items(items) { item ->
                       ContinueWatchingCard(
                           item = item,
                           onClick = { onItemClick(item) },
                           onDelete = { onDeleteItem(item) }
                       )
                   }
               }
           }
       }
       ```

    4. Create `ContinueWatchingCard` composable (Netflix-style with progress bar at bottom of thumbnail):
       ```kotlin
       @OptIn(ExperimentalFoundationApi::class)
       @Composable
       private fun ContinueWatchingCard(
           item: WatchHistoryEntity,
           onClick: () -> Unit,
           onDelete: () -> Unit
       ) {
           var showMenu by remember { mutableStateOf(false) }

           Card(
               modifier = Modifier
                   .width(160.dp)
                   .combinedClickable(
                       onClick = onClick,
                       onLongClick = { showMenu = true }
                   ),
               shape = RoundedCornerShape(12.dp),
               colors = CardDefaults.cardColors(
                   containerColor = MaterialTheme.colorScheme.surfaceContainer
               )
           ) {
               Box {
                   Column {
                       Box {
                           AsyncImage(
                               model = item.coverUrl,
                               contentDescription = item.title,
                               contentScale = ContentScale.Crop,
                               modifier = Modifier
                                   .fillMaxWidth()
                                   .aspectRatio(16f / 9f)
                                   .clip(RoundedCornerShape(topStart = 12.dp, topEnd = 12.dp))
                           )
                           // Thin progress bar at bottom of thumbnail
                           LinearProgressIndicator(
                               progress = { item.progressPercentage.coerceIn(0f, 1f) },
                               modifier = Modifier
                                   .fillMaxWidth()
                                   .height(3.dp)
                                   .align(Alignment.BottomCenter),
                               color = MaterialTheme.colorScheme.primary,
                               trackColor = Color.Black.copy(alpha = 0.5f)
                           )
                       }
                       Text(
                           text = item.title,
                           maxLines = 2,
                           overflow = TextOverflow.Ellipsis,
                           modifier = Modifier.padding(8.dp),
                           style = MaterialTheme.typography.bodySmall,
                           color = MaterialTheme.colorScheme.onSurface
                       )
                   }

                   // Long-press dropdown menu
                   DropdownMenu(
                       expanded = showMenu,
                       onDismissRequest = { showMenu = false }
                   ) {
                       DropdownMenuItem(
                           text = { Text("Continue") },
                           onClick = {
                               showMenu = false
                               onClick()
                           }
                       )
                       DropdownMenuItem(
                           text = { Text("Delete") },
                           onClick = {
                               showMenu = false
                               onDelete()
                           }
                       )
                       DropdownMenuItem(
                           text = { Text("Details") },
                           onClick = {
                               showMenu = false
                               onClick() // Navigate to details (same as tap for now)
                           }
                       )
                   }
               }
           }
       }
       ```

    5. Create `ContinueReadingRow` composable (same structure as ContinueWatchingRow but uses ContinueReadingCard):
       Same as ContinueWatchingRow but title is "Continue Reading" and uses `ContinueReadingCard`.

    6. Create `ContinueReadingCard` composable (manga: percentage text overlay instead of progress bar):
       ```kotlin
       @OptIn(ExperimentalFoundationApi::class)
       @Composable
       private fun ContinueReadingCard(
           item: WatchHistoryEntity,
           onClick: () -> Unit,
           onDelete: () -> Unit
       ) {
           var showMenu by remember { mutableStateOf(false) }

           Card(
               modifier = Modifier
                   .width(135.dp)
                   .combinedClickable(
                       onClick = onClick,
                       onLongClick = { showMenu = true }
                   ),
               shape = RoundedCornerShape(12.dp),
               colors = CardDefaults.cardColors(
                   containerColor = MaterialTheme.colorScheme.surfaceContainer
               )
           ) {
               Box {
                   Column {
                       Box {
                           AsyncImage(
                               model = item.coverUrl,
                               contentDescription = item.title,
                               contentScale = ContentScale.Crop,
                               modifier = Modifier
                                   .fillMaxWidth()
                                   .aspectRatio(0.7f)
                                   .clip(RoundedCornerShape(topStart = 12.dp, topEnd = 12.dp))
                           )
                           // Percentage overlay at bottom-right of thumbnail
                           Surface(
                               modifier = Modifier
                                   .align(Alignment.BottomEnd)
                                   .padding(6.dp),
                               shape = RoundedCornerShape(6.dp),
                               color = Color.Black.copy(alpha = 0.7f)
                           ) {
                               Text(
                                   text = "${(item.progressPercentage * 100).toInt()}%",
                                   modifier = Modifier.padding(horizontal = 6.dp, vertical = 2.dp),
                                   style = MaterialTheme.typography.labelSmall,
                                   fontWeight = FontWeight.SemiBold,
                                   color = Color.White
                               )
                           }
                       }
                       Text(
                           text = item.title,
                           maxLines = 2,
                           overflow = TextOverflow.Ellipsis,
                           modifier = Modifier.padding(8.dp),
                           style = MaterialTheme.typography.bodySmall,
                           color = MaterialTheme.colorScheme.onSurface
                       )
                   }

                   // Long-press dropdown menu (same as watching card)
                   DropdownMenu(
                       expanded = showMenu,
                       onDismissRequest = { showMenu = false }
                   ) {
                       DropdownMenuItem(
                           text = { Text("Continue") },
                           onClick = {
                               showMenu = false
                               onClick()
                           }
                       )
                       DropdownMenuItem(
                           text = { Text("Delete") },
                           onClick = {
                               showMenu = false
                               onDelete()
                           }
                       )
                       DropdownMenuItem(
                           text = { Text("Details") },
                           onClick = {
                               showMenu = false
                               onClick()
                           }
                       )
                   }
               }
           }
       }
       ```

    7. Style notes from CONTEXT.md decisions:
       - Video cards: 16:9 aspect ratio, thin 3dp progress bar at very bottom edge of thumbnail
       - Manga cards: 0.7 aspect ratio (portrait), percentage badge at bottom-right corner
       - Both: RoundedCornerShape(12.dp), title below thumbnail, max 2 lines with ellipsis
       - Cards should feel like Netflix "Continue Watching" -- thumbnail-forward, minimal text
       - Use `MaterialTheme.colorScheme.primary` for progress bar color
       - Row titles use `titleLarge` with `FontWeight.Bold` (matching existing section rows)
  </action>
  <verify>Run `cd C:/Users/black/AndroidStudioProjects/omnistream && ./gradlew compileDebugKotlin 2>&1 | tail -30`. No compilation errors in HomeScreen. Verify composables `ContinueWatchingCard` and `ContinueReadingCard` exist.</verify>
  <done>Home screen shows Continue Watching and Continue Reading rows at the top when history exists. Video cards have progress bars at thumbnail bottom. Manga cards have percentage overlays. Long-press shows dropdown with Delete, Continue, Details. Rows hide when empty. Max 10 items per row, ordered by most recent. PLAYER-01 complete.</done>
</task>

</tasks>

<verification>
1. `./gradlew compileDebugKotlin` passes
2. HomeViewModel constructor includes `WatchHistoryRepository`
3. HomeUiState has `continueWatching` and `continueReading` fields
4. HomeScreen LazyColumn renders Continue rows BEFORE video/manga sections
5. ContinueWatchingCard has `LinearProgressIndicator` at bottom of thumbnail
6. ContinueReadingCard has percentage text overlay
7. Both card types have `combinedClickable` with `onLongClick` and `DropdownMenu`
8. `deleteFromHistory` method exists on HomeViewModel
9. Continue rows are hidden when their lists are empty (conditional `if` check)
</verification>

<success_criteria>
- Continue Watching row appears at top of Home screen with video progress items
- Continue Reading row appears below Continue Watching with manga progress items
- Video items show thin progress bar at bottom of thumbnail (Netflix-style)
- Manga items show percentage text overlay (e.g., "30%")
- Max 10 items per row, ordered by most recently watched/read
- Completed content does not appear (filtered by is_completed = 0 in DAO query)
- Rows hidden entirely when no history exists
- Tap navigates to content detail page
- Long press shows dropdown menu with Delete, Continue, and Details options
- Delete removes item from Continue row (deletes from watch_history table)
</success_criteria>

<output>
After completion, create `.planning/phases/08-foundation-bug-fixes-progress/08-04-SUMMARY.md`
</output>
