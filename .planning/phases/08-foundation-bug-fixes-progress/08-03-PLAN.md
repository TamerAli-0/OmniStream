---
phase: 08-foundation-bug-fixes-progress
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - app/src/main/java/com/omnistream/ui/reader/ReaderViewModel.kt
  - app/src/main/java/com/omnistream/ui/player/PlayerViewModel.kt
  - app/src/main/java/com/omnistream/ui/player/PlayerScreen.kt
autonomous: true

must_haves:
  truths:
    - "User exits a manga chapter mid-read, reopens it later, and resumes from the exact page"
    - "Manga reading progress auto-saves every 12 seconds while reading"
    - "Video progress saves on pause and on exit (not periodic)"
    - "Video position is captured BEFORE ExoPlayer is released"
    - "Resume dialog shows when PlayerScreen loads with existing progress"
  artifacts:
    - path: "app/src/main/java/com/omnistream/ui/reader/ReaderViewModel.kt"
      provides: "Auto-save reading progress every 12s + on chapter change + on exit"
      contains: "watchHistoryRepository"
    - path: "app/src/main/java/com/omnistream/ui/player/PlayerViewModel.kt"
      provides: "Video progress save on pause/exit, load saved position"
      contains: "watchHistoryRepository"
    - path: "app/src/main/java/com/omnistream/ui/player/PlayerScreen.kt"
      provides: "Resume dialog and progress save on dispose"
      contains: "AlertDialog"
  key_links:
    - from: "ReaderViewModel.kt"
      to: "WatchHistoryRepository"
      via: "Hilt injection, upsert on timer + chapter change"
      pattern: "watchHistoryRepository\\.upsert"
    - from: "PlayerViewModel.kt"
      to: "WatchHistoryRepository"
      via: "Hilt injection, save + load progress"
      pattern: "watchHistoryRepository"
    - from: "PlayerScreen.kt"
      to: "PlayerViewModel"
      via: "save before dispose, resume dialog"
      pattern: "saveVideoProgress|showResumeDialog"
---

<objective>
Add reading progress persistence (BUG-03) and video progress tracking for the resume feature (part of PLAYER-01).

Purpose: Users must be able to exit mid-read/watch and come back to the exact position. This wires WatchHistoryRepository (from Plan 01) into ReaderViewModel and PlayerViewModel, adding auto-save for manga and save-on-pause/exit for video.

Output: Updated ReaderViewModel.kt with auto-save, updated PlayerViewModel.kt with progress save/load, updated PlayerScreen.kt with resume dialog.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-foundation-bug-fixes-progress/08-CONTEXT.md
@.planning/phases/08-foundation-bug-fixes-progress/08-RESEARCH.md

Key source files:
@app/src/main/java/com/omnistream/ui/reader/ReaderViewModel.kt
@app/src/main/java/com/omnistream/ui/player/PlayerViewModel.kt
@app/src/main/java/com/omnistream/ui/player/PlayerScreen.kt
@app/src/main/java/com/omnistream/data/local/WatchHistoryEntity.kt (created by Plan 01)
@app/src/main/java/com/omnistream/data/repository/WatchHistoryRepository.kt (created by Plan 01)

Plan 01 SUMMARY (if available):
@.planning/phases/08-foundation-bug-fixes-progress/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add manga reading progress auto-save to ReaderViewModel (BUG-03)</name>
  <files>
    app/src/main/java/com/omnistream/ui/reader/ReaderViewModel.kt
  </files>
  <action>
    **ReaderViewModel.kt -- add WatchHistoryRepository injection and auto-save:**

    1. Add `WatchHistoryRepository` to the constructor: `@Inject constructor(private val sourceManager: SourceManager, private val watchHistoryRepository: WatchHistoryRepository, savedStateHandle: SavedStateHandle)`
    2. Add imports for `WatchHistoryRepository`, `WatchHistoryEntity`, `kotlinx.coroutines.Job`, `kotlinx.coroutines.isActive`, `kotlinx.coroutines.delay`.
    3. Add fields:
       - `private var autoSaveJob: Job? = null`
       - `private var mangaTitle: String = ""` (populate from navigation or load)
       - `private var coverUrl: String? = null` (add as SavedStateHandle param if available, or leave null)
    4. Add `mangaTitle` and `coverUrl` as SavedStateHandle params: `private val mangaTitle: String = savedStateHandle["title"] ?: ""` and `private val coverUrl: String? = savedStateHandle["coverUrl"]`. These should be passed from navigation. If not available, leave as empty/null -- they'll be populated when the reader loads.

    5. Add `startAutoSave()` method:
       ```kotlin
       private fun startAutoSave() {
           autoSaveJob?.cancel()
           autoSaveJob = viewModelScope.launch {
               while (isActive) {
                   delay(12_000) // 12 seconds
                   saveCurrentProgress()
               }
           }
       }
       ```

    6. Add `saveCurrentProgress()` suspend method:
       ```kotlin
       private suspend fun saveCurrentProgress() {
           val state = _uiState.value
           if (state.pages.isEmpty()) return
           watchHistoryRepository.upsert(
               WatchHistoryEntity(
                   id = "$sourceId:$mangaId",
                   contentId = mangaId,
                   sourceId = sourceId,
                   contentType = "manga",
                   title = mangaTitle,
                   coverUrl = coverUrl,
                   chapterId = currentChapterId,
                   chapterIndex = currentChapterIndex.coerceAtLeast(0),
                   totalChapters = chapterList.size,
                   progressPosition = state.currentPage.toLong(),
                   totalDuration = state.pages.size.toLong(),
                   progressPercentage = if (chapterList.isNotEmpty() && currentChapterIndex >= 0)
                       (currentChapterIndex + 1).toFloat() / chapterList.size
                   else
                       (state.currentPage + 1).toFloat() / state.pages.size.coerceAtLeast(1),
                   lastWatchedAt = System.currentTimeMillis(),
                   isCompleted = chapterList.isNotEmpty() &&
                       currentChapterIndex == chapterList.size - 1 &&
                       state.currentPage >= state.pages.size - 1
               )
           )
       }
       ```

    7. Call `startAutoSave()` at the end of `loadCurrentChapterPages()` after pages are loaded (after `_uiState.value = ...`).

    8. Save progress on chapter change: In `goToNextChapter()` and `goToPreviousChapter()`, call `viewModelScope.launch { saveCurrentProgress() }` before changing chapters.

    9. Load saved progress on init: After `loadCurrentChapterPages()` completes, check for saved progress:
       ```kotlin
       // After pages are loaded, check for saved progress to resume
       val savedProgress = watchHistoryRepository.getProgress(mangaId, sourceId)
       if (savedProgress != null && savedProgress.chapterId == currentChapterId) {
           val savedPage = savedProgress.progressPosition.toInt()
               .coerceIn(0, (pages.size - 1).coerceAtLeast(0))
           _uiState.value = _uiState.value.copy(currentPage = savedPage)
       }
       ```
       Place this in `loadChapterListThenPages()` after `loadCurrentChapterPages(source)` returns.

    10. Override `onCleared()` to save progress and cancel auto-save:
        ```kotlin
        override fun onCleared() {
            super.onCleared()
            autoSaveJob?.cancel()
            // Fire-and-forget final save (won't complete if process killed, but best effort)
        }
        ```
        Note: `onCleared()` cancels viewModelScope, so we can't launch a coroutine here. The auto-save every 12s is the safety net. The most we can do is cancel the job.

    11. Add `mangaTitle` to `ReaderUiState` so it can be set when chapter list loads:
        - Add `val mangaTitle: String = ""` to `ReaderUiState`
        - When chapter list loads successfully, update: `_uiState.value = _uiState.value.copy(mangaTitle = mangaTitle)` if it becomes available from the source.
        - Actually, since ReaderViewModel gets `mangaTitle` from SavedStateHandle, just use the field directly. If it's empty (not passed), set it from the first loaded page's parent title if available, or leave empty.

    IMPORTANT: The `setCurrentPage(page: Int)` function already exists and is called by ReaderScreen when scroll position changes. This is what drives the auto-save data being current.
  </action>
  <verify>Run `cd C:/Users/black/AndroidStudioProjects/omnistream && ./gradlew compileDebugKotlin 2>&1 | grep -i "reader"`. No compilation errors in ReaderViewModel. Verify `watchHistoryRepository` is in the constructor. Verify `autoSaveJob` and `saveCurrentProgress` exist.</verify>
  <done>ReaderViewModel auto-saves manga reading progress every 12 seconds. Saves exact page index and chapter. Loads saved progress on init to resume from last page. Saves before chapter navigation. BUG-03 fixed.</done>
</task>

<task type="auto">
  <name>Task 2: Add video progress save/load and resume dialog to PlayerViewModel + PlayerScreen</name>
  <files>
    app/src/main/java/com/omnistream/ui/player/PlayerViewModel.kt
    app/src/main/java/com/omnistream/ui/player/PlayerScreen.kt
  </files>
  <action>
    **PlayerViewModel.kt -- add progress save and load:**

    1. Add `WatchHistoryRepository` to constructor: `@Inject constructor(private val sourceManager: SourceManager, private val watchHistoryRepository: WatchHistoryRepository, savedStateHandle: SavedStateHandle)`
    2. Add fields from SavedStateHandle:
       - `val videoTitle: String = savedStateHandle["title"] ?: ""`
       - `val coverUrl: String? = savedStateHandle["coverUrl"]`
    3. Add to `PlayerUiState`:
       - `val savedPosition: Long? = null` -- non-null when there's a saved position to resume from
       - `val showResumeDialog: Boolean = false`
    4. Add method `loadSavedProgress()`:
       ```kotlin
       private fun loadSavedProgress() {
           viewModelScope.launch {
               val saved = watchHistoryRepository.getProgress(videoId, sourceId)
               if (saved != null && !saved.isCompleted && saved.progressPosition > 0) {
                   _uiState.value = _uiState.value.copy(
                       savedPosition = saved.progressPosition,
                       showResumeDialog = true
                   )
               }
           }
       }
       ```
       Call this in `init {}` after `loadVideoLinks()`.

    5. Add `dismissResumeDialog()` method:
       ```kotlin
       fun dismissResumeDialog() {
           _uiState.value = _uiState.value.copy(showResumeDialog = false)
       }

       fun startFromBeginning() {
           _uiState.value = _uiState.value.copy(showResumeDialog = false, savedPosition = null)
       }
       ```

    6. Add `saveVideoProgress(positionMs: Long, durationMs: Long)` public method:
       ```kotlin
       fun saveVideoProgress(positionMs: Long, durationMs: Long) {
           if (durationMs <= 0) return
           val percentage = positionMs.toFloat() / durationMs
           val isCompleted = percentage > 0.90f
           viewModelScope.launch {
               watchHistoryRepository.upsert(
                   WatchHistoryEntity(
                       id = "$sourceId:$videoId",
                       contentId = videoId,
                       sourceId = sourceId,
                       contentType = "video",
                       title = videoTitle.ifBlank { _uiState.value.episodeTitle ?: "Unknown" },
                       coverUrl = coverUrl,
                       episodeId = episodeId,
                       progressPosition = positionMs,
                       totalDuration = durationMs,
                       progressPercentage = percentage,
                       lastWatchedAt = System.currentTimeMillis(),
                       isCompleted = isCompleted
                   )
               )
           }
       }
       ```
    7. Add imports for `WatchHistoryRepository`, `WatchHistoryEntity`.

    **PlayerScreen.kt -- add resume dialog and save-on-dispose:**

    1. Add resume dialog: After the `BackHandler` block, add:
       ```kotlin
       // Resume dialog
       if (uiState.showResumeDialog && uiState.savedPosition != null) {
           AlertDialog(
               onDismissRequest = { viewModel.dismissResumeDialog() },
               title = { Text("Resume Playback") },
               text = {
                   val minutes = (uiState.savedPosition!! / 1000 / 60).toInt()
                   val seconds = (uiState.savedPosition!! / 1000 % 60).toInt()
                   Text("Resume from ${minutes}:${String.format("%02d", seconds)}?")
               },
               confirmButton = {
                   TextButton(onClick = {
                       exoPlayer?.seekTo(uiState.savedPosition!!)
                       viewModel.dismissResumeDialog()
                   }) { Text("Resume") }
               },
               dismissButton = {
                   TextButton(onClick = {
                       viewModel.startFromBeginning()
                   }) { Text("Start Over") }
               }
           )
       }
       ```
       Import `AlertDialog` from `androidx.compose.material3`.

    2. Save progress on pause: In the `onPlayPause` lambda (inside PlayerControls), after `player.pause()`, add:
       ```kotlin
       if (player.isPlaying) {
           player.pause()
           viewModel.saveVideoProgress(player.currentPosition, player.duration)
       } else {
           player.play()
       }
       ```

    3. Save progress on back/exit: In the existing `DisposableEffect(Unit)` that handles fullscreen mode, add to the `onDispose` block (BEFORE restoring orientation):
       ```kotlin
       // Save video progress before leaving
       exoPlayer?.let { player ->
           if (player.duration > 0) {
               viewModel.saveVideoProgress(player.currentPosition, player.duration)
           }
       }
       ```
       CRITICAL: This must run BEFORE `exoPlayer?.release()` if there's a release call. Check if release happens elsewhere. The VideoPlayer composable likely has its own DisposableEffect that releases the player. The save must happen before that.

    4. Also save on back button press: In the `BackHandler` block, before `navController.popBackStack()`:
       ```kotlin
       exoPlayer?.let { player ->
           if (player.duration > 0) {
               viewModel.saveVideoProgress(player.currentPosition, player.duration)
           }
       }
       navController.popBackStack()
       ```

    5. Seek to saved position when player is ready: Add a `LaunchedEffect` that watches for `uiState.savedPosition` and `exoPlayer`:
       ```kotlin
       LaunchedEffect(uiState.savedPosition, exoPlayer) {
           val pos = uiState.savedPosition
           if (pos != null && !uiState.showResumeDialog && exoPlayer != null) {
               exoPlayer?.seekTo(pos)
           }
       }
       ```
       This handles the case where user clicks "Resume" in the dialog.

    IMPORTANT: Do NOT change the VideoPlayer composable itself. Only modify PlayerScreen and PlayerViewModel.
  </action>
  <verify>Run `cd C:/Users/black/AndroidStudioProjects/omnistream && ./gradlew compileDebugKotlin 2>&1 | tail -30`. No errors. Verify `saveVideoProgress` exists in PlayerViewModel. Verify `AlertDialog` and resume logic exist in PlayerScreen.</verify>
  <done>Video progress saves on pause and back/exit. Resume dialog appears when reopening a video with saved progress. User can choose "Resume" or "Start Over". Position is captured before ExoPlayer release. Video progress tracking for PLAYER-01 is wired.</done>
</task>

</tasks>

<verification>
1. `./gradlew compileDebugKotlin` passes
2. ReaderViewModel has `watchHistoryRepository` in constructor and `autoSaveJob` with 12s delay
3. ReaderViewModel loads saved progress and sets `currentPage` on init
4. PlayerViewModel has `saveVideoProgress()` and `loadSavedProgress()` methods
5. PlayerScreen shows AlertDialog for resume with position formatted as M:SS
6. PlayerScreen saves progress in BackHandler before popBackStack
7. PlayerScreen saves progress in DisposableEffect onDispose before player release
</verification>

<success_criteria>
- Manga reading progress auto-saves every 12 seconds
- Manga reader resumes from exact page when reopening same chapter
- Video progress saves on pause and on exit
- Video resume shows prompt with "Resume from X:XX" and "Start Over" options
- Progress data flows through WatchHistoryRepository to Room database
- No progress saves with invalid data (empty pages, zero duration)
</success_criteria>

<output>
After completion, create `.planning/phases/08-foundation-bug-fixes-progress/08-03-SUMMARY.md`
</output>
