---
phase: 08-foundation-bug-fixes-progress
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/main/java/com/omnistream/data/local/AppDatabase.kt
  - app/src/main/java/com/omnistream/data/local/WatchHistoryEntity.kt
  - app/src/main/java/com/omnistream/data/local/WatchHistoryDao.kt
  - app/src/main/java/com/omnistream/data/local/SearchHistoryEntity.kt
  - app/src/main/java/com/omnistream/data/local/SearchHistoryDao.kt
  - app/src/main/java/com/omnistream/data/local/DownloadEntity.kt
  - app/src/main/java/com/omnistream/data/local/DownloadDao.kt
  - app/src/main/java/com/omnistream/data/repository/WatchHistoryRepository.kt
  - app/src/main/java/com/omnistream/di/AppModule.kt
autonomous: true

must_haves:
  truths:
    - "Room database migrates from v1 to v2 without losing existing favorites data"
    - "WatchHistoryEntity can store both video and manga progress with upsert semantics"
    - "WatchHistoryDao can query Continue Watching and Continue Reading items separately"
    - "WatchHistoryRepository is injectable via Hilt throughout the app"
  artifacts:
    - path: "app/src/main/java/com/omnistream/data/local/WatchHistoryEntity.kt"
      provides: "WatchHistory Room entity"
      contains: "@Entity(tableName = \"watch_history\")"
    - path: "app/src/main/java/com/omnistream/data/local/WatchHistoryDao.kt"
      provides: "DAO with getContinueItems, getProgress, upsert, delete queries"
      contains: "@Dao"
    - path: "app/src/main/java/com/omnistream/data/repository/WatchHistoryRepository.kt"
      provides: "Repository wrapping WatchHistoryDao"
      contains: "class WatchHistoryRepository"
    - path: "app/src/main/java/com/omnistream/data/local/AppDatabase.kt"
      provides: "Room DB v2 with migration"
      contains: "version = 2"
    - path: "app/src/main/java/com/omnistream/di/AppModule.kt"
      provides: "Hilt providers for new DAOs and repository"
      contains: "provideWatchHistoryDao"
  key_links:
    - from: "AppDatabase.kt"
      to: "WatchHistoryEntity, SearchHistoryEntity, DownloadEntity"
      via: "entities array in @Database annotation"
      pattern: "entities.*WatchHistoryEntity"
    - from: "AppModule.kt"
      to: "AppDatabase.kt"
      via: "addMigrations(MIGRATION_1_2)"
      pattern: "addMigrations"
    - from: "AppModule.kt"
      to: "WatchHistoryRepository"
      via: "Hilt @Provides"
      pattern: "provideWatchHistoryRepository"
---

<objective>
Create the Room database migration from v1 to v2, adding watch_history, search_history, and downloads tables, plus WatchHistoryEntity/DAO/Repository with Hilt wiring.

Purpose: This is the data foundation for all Phase 8 features (progress tracking, continue rows) and Phase 9 (downloads) and Phase 10 (search history). Every subsequent plan depends on these tables existing.

Output: Six new Kotlin files (3 entities, 3 DAOs, 1 repository), plus updated AppDatabase.kt and AppModule.kt.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-foundation-bug-fixes-progress/08-RESEARCH.md

Key source files:
@app/src/main/java/com/omnistream/data/local/AppDatabase.kt
@app/src/main/java/com/omnistream/data/local/FavoriteEntity.kt
@app/src/main/java/com/omnistream/data/local/FavoriteDao.kt
@app/src/main/java/com/omnistream/di/AppModule.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Room entities and DAOs for watch_history, search_history, and downloads</name>
  <files>
    app/src/main/java/com/omnistream/data/local/WatchHistoryEntity.kt
    app/src/main/java/com/omnistream/data/local/WatchHistoryDao.kt
    app/src/main/java/com/omnistream/data/local/SearchHistoryEntity.kt
    app/src/main/java/com/omnistream/data/local/SearchHistoryDao.kt
    app/src/main/java/com/omnistream/data/local/DownloadEntity.kt
    app/src/main/java/com/omnistream/data/local/DownloadDao.kt
  </files>
  <action>
    Create six new files in `data/local/` following the exact patterns from FavoriteEntity.kt and FavoriteDao.kt:

    **WatchHistoryEntity.kt:**
    - Package: `com.omnistream.data.local`
    - `@Entity(tableName = "watch_history")` data class
    - Fields (matching the migration SQL exactly):
      - `@PrimaryKey val id: String` -- format "sourceId:contentId" (one entry per content, not per episode)
      - `val contentId: String`
      - `val sourceId: String`
      - `val contentType: String` -- "video" or "manga"
      - `val title: String`
      - `val coverUrl: String? = null`
      - `@ColumnInfo(name = "episode_id") val episodeId: String? = null` -- current episode for video
      - `@ColumnInfo(name = "chapter_id") val chapterId: String? = null` -- current chapter for manga
      - `@ColumnInfo(name = "chapter_index") val chapterIndex: Int = 0` -- for manga: which chapter in the list
      - `@ColumnInfo(name = "total_chapters") val totalChapters: Int = 0` -- for manga: total chapter count
      - `@ColumnInfo(name = "progress_position") val progressPosition: Long = 0L` -- video: ms position, manga: page index
      - `@ColumnInfo(name = "total_duration") val totalDuration: Long = 0L` -- video: total ms, manga: total pages
      - `@ColumnInfo(name = "progress_percentage") val progressPercentage: Float = 0f` -- 0.0 to 1.0
      - `@ColumnInfo(name = "last_watched_at") val lastWatchedAt: Long = System.currentTimeMillis()`
      - `@ColumnInfo(name = "is_completed") val isCompleted: Boolean = false`
    - Use `@ColumnInfo` for snake_case column names on multi-word fields

    **WatchHistoryDao.kt:**
    - `@Dao interface WatchHistoryDao`
    - `getContinueWatching(limit: Int = 10): Flow<List<WatchHistoryEntity>>` -- query where content_type = 'video' AND is_completed = 0, ORDER BY last_watched_at DESC, LIMIT :limit
    - `getContinueReading(limit: Int = 10): Flow<List<WatchHistoryEntity>>` -- same but content_type = 'manga'
    - `getProgress(contentId: String, sourceId: String): WatchHistoryEntity?` -- suspend, query by content_id AND source_id
    - `upsert(entity: WatchHistoryEntity)` -- `@Insert(onConflict = OnConflictStrategy.REPLACE)`
    - `delete(id: String)` -- suspend, DELETE by id
    - `clearAll()` -- suspend, DELETE all from watch_history

    **SearchHistoryEntity.kt:**
    - `@Entity(tableName = "search_history")` data class
    - `@PrimaryKey(autoGenerate = true) val id: Int = 0`
    - `val query: String`
    - `@ColumnInfo(name = "searched_at") val searchedAt: Long = System.currentTimeMillis()`

    **SearchHistoryDao.kt:**
    - `@Dao interface SearchHistoryDao`
    - `getRecentSearches(limit: Int = 20): Flow<List<SearchHistoryEntity>>` -- ORDER BY searched_at DESC LIMIT :limit
    - `insert(entity: SearchHistoryEntity)` -- suspend, @Insert
    - `deleteByQuery(query: String)` -- suspend, DELETE WHERE query = :query
    - `clearAll()` -- suspend, DELETE all

    **DownloadEntity.kt:**
    - `@Entity(tableName = "downloads")` data class
    - Fields: id (String PK), contentId, sourceId, contentType, title, coverUrl (nullable), episodeId (nullable), chapterId (nullable), filePath, fileSize (Long, default 0), status (String, default "pending"), progress (Float, default 0f), createdAt (Long)
    - Use `@ColumnInfo` for snake_case on multi-word fields

    **DownloadDao.kt:**
    - `@Dao interface DownloadDao`
    - `getAllDownloads(): Flow<List<DownloadEntity>>` -- ORDER BY created_at DESC
    - `getByStatus(status: String): Flow<List<DownloadEntity>>`
    - `upsert(entity: DownloadEntity)` -- @Insert REPLACE
    - `updateProgress(id: String, progress: Float, status: String)` -- @Query UPDATE
    - `delete(id: String)` -- suspend
    - `clearAll()` -- suspend

    IMPORTANT: Import `kotlinx.coroutines.flow.Flow` for all Flow return types. Import `androidx.room.*` annotations.
  </action>
  <verify>All six files compile. Check with: `cd C:/Users/black/AndroidStudioProjects/omnistream && ./gradlew compileDebugKotlin 2>&1 | tail -20` (may show errors from AppDatabase not yet updated -- that's expected, verify no syntax errors in the new files themselves).</verify>
  <done>Six new Kotlin files exist in data/local/ with correct Room annotations, column names matching the migration SQL, and proper Flow return types on DAO queries.</done>
</task>

<task type="auto">
  <name>Task 2: Update AppDatabase migration, create WatchHistoryRepository, wire Hilt providers</name>
  <files>
    app/src/main/java/com/omnistream/data/local/AppDatabase.kt
    app/src/main/java/com/omnistream/data/repository/WatchHistoryRepository.kt
    app/src/main/java/com/omnistream/di/AppModule.kt
  </files>
  <action>
    **AppDatabase.kt -- update to v2 with migration:**
    - Change `@Database` annotation: `entities = [FavoriteEntity::class, WatchHistoryEntity::class, SearchHistoryEntity::class, DownloadEntity::class]`, `version = 2`, keep `exportSchema = false`
    - Add abstract DAO functions: `abstract fun watchHistoryDao(): WatchHistoryDao`, `abstract fun searchHistoryDao(): SearchHistoryDao`, `abstract fun downloadDao(): DownloadDao`
    - Add companion object with `val MIGRATION_1_2 = object : Migration(1, 2)` containing three CREATE TABLE IF NOT EXISTS statements:
      - watch_history table: columns must EXACTLY match WatchHistoryEntity field names with @ColumnInfo names. Include the two new fields chapter_index (INTEGER NOT NULL DEFAULT 0) and total_chapters (INTEGER NOT NULL DEFAULT 0) that were added beyond the research template.
      - search_history table: id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, query TEXT NOT NULL, searched_at INTEGER NOT NULL DEFAULT 0
      - downloads table: all fields from DownloadEntity with correct types
    - Import `androidx.room.migration.Migration` and `androidx.sqlite.db.SupportSQLiteDatabase`
    - CRITICAL: Do NOT use `fallbackToDestructiveMigration()` anywhere. The migration preserves existing favorites.

    **WatchHistoryRepository.kt:**
    - Package: `com.omnistream.data.repository`
    - Class with `@Inject constructor(private val watchHistoryDao: WatchHistoryDao)`
    - Methods that delegate to DAO:
      - `fun getContinueWatching(): Flow<List<WatchHistoryEntity>>` = dao.getContinueWatching()
      - `fun getContinueReading(): Flow<List<WatchHistoryEntity>>` = dao.getContinueReading()
      - `suspend fun getProgress(contentId: String, sourceId: String): WatchHistoryEntity?` = dao.getProgress(...)
      - `suspend fun upsert(entity: WatchHistoryEntity)` = dao.upsert(entity)
      - `suspend fun delete(id: String)` = dao.delete(id)
    - Import the entity and DAO from data.local package
    - Import `javax.inject.Inject` and `kotlinx.coroutines.flow.Flow`

    **AppModule.kt -- add Hilt providers:**
    - Update `provideAppDatabase` to add migration: `Room.databaseBuilder(...).addMigrations(AppDatabase.MIGRATION_1_2).build()`
    - Add provider: `@Provides fun provideWatchHistoryDao(database: AppDatabase): WatchHistoryDao = database.watchHistoryDao()`
    - Add provider: `@Provides fun provideSearchHistoryDao(database: AppDatabase): SearchHistoryDao = database.searchHistoryDao()`
    - Add provider: `@Provides fun provideDownloadDao(database: AppDatabase): DownloadDao = database.downloadDao()`
    - Add provider: `@Provides @Singleton fun provideWatchHistoryRepository(watchHistoryDao: WatchHistoryDao): WatchHistoryRepository = WatchHistoryRepository(watchHistoryDao)`
    - Add necessary imports for the new classes

    CRITICAL: The CREATE TABLE SQL column names must EXACTLY match the @ColumnInfo names on the entities. Mismatch = runtime crash.
  </action>
  <verify>Run `cd C:/Users/black/AndroidStudioProjects/omnistream && ./gradlew compileDebugKotlin 2>&1 | tail -30`. All files compile without errors. Specifically verify no "Cannot find symbol" or "Unresolved reference" errors for the new entities/DAOs.</verify>
  <done>AppDatabase is v2 with MIGRATION_1_2 containing three CREATE TABLE statements. WatchHistoryRepository exists and is injectable. All new DAOs are provided by Hilt via AppModule. Project compiles.</done>
</task>

</tasks>

<verification>
1. `./gradlew compileDebugKotlin` passes with no errors
2. AppDatabase.kt has `version = 2` and `MIGRATION_1_2` companion object
3. AppModule.kt calls `.addMigrations(AppDatabase.MIGRATION_1_2)` on the database builder
4. WatchHistoryRepository has `@Inject constructor` and delegates to WatchHistoryDao
5. All six new files (3 entities + 3 DAOs) exist in `data/local/`
</verification>

<success_criteria>
- Room database schema upgraded from v1 to v2 with proper migration (no destructive fallback)
- WatchHistoryEntity supports both video (ms position) and manga (page index) progress
- WatchHistoryDao has Flow-based queries for Continue Watching and Continue Reading
- WatchHistoryRepository is injectable via Hilt
- SearchHistory and Download entities/DAOs exist for Phase 10 and Phase 9
- Project compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/08-foundation-bug-fixes-progress/08-01-SUMMARY.md`
</output>
